# Spline Visualization Outputs Guide

This document provides a comprehensive explanation of the spline forecasting visualization outputs generated by the Extended Interpretable Time Series Forecasting Model.

## üìä Overview

The extended model generates two main visualization files that provide complete insight into the spline-based forecasting process:

1. **`spline_forecasts.png`** - Main forecasting results with accuracy assessment
2. **`spline_analysis.png`** - Detailed spline mathematical analysis

These visualizations are automatically generated when running:
- `python test_spline_visualization.py`
- `python validate_extended_model.py`

## üéØ Main Forecasting Visualization (`spline_forecasts.png`)

### Layout: 2√ó2 Grid of Variable Forecasts

The main visualization shows a 2√ó2 grid displaying the first 4 ETT variables (HUFL, HULL, MUFL, MULL). Each subplot contains:

#### Visual Elements

**üîµ Blue Solid Line - Historical Data**
- Represents the input time series data used by the model
- Shows the historical pattern that the model learned from
- Typically covers 96-168 time steps depending on the input window size

**üî¥ Red Line with Circles - Spline Forecast**
- The model's predictions for future time steps
- Generated using B-spline functions with learned control points
- Smooth, continuous curves that extrapolate from historical patterns
- Circle markers indicate individual forecast time steps

**üü¢ Green Dashed Line with Squares - True Future Values**
- Actual observed values for the forecast period (when available)
- Used for accuracy assessment and model validation
- Square markers distinguish from forecast predictions
- Enables direct visual comparison of forecast quality

**üü£ Purple Squares - B-Spline Control Points**
- Mathematical parameters that define the spline curve shape
- Connected by dashed purple lines to show spline structure
- Positioned in parameter space (may extend beyond forecast period)
- Provide interpretable insight into how the model constructs forecasts

**‚ö™ Gray Vertical Dashed Line - History/Forecast Separator**
- Clearly separates historical data from forecast period
- Helps visualize the transition from known to predicted values

**üî¥ Red Shaded Region - Forecast Period**
- Light red background highlighting the prediction time range
- Makes it easy to identify which portion represents forecasts

#### Information Boxes

**üìä Accuracy Metrics Box (Top Left)**
- **MSE (Mean Squared Error)**: Average squared difference between forecast and true values
- **MAE (Mean Absolute Error)**: Average absolute difference between forecast and true values
- Lower values indicate better forecast accuracy
- Displayed with yellow background for easy identification

**üìà Trend Analysis Box (Bottom Right)**
- **Hist Trend**: Linear trend coefficient from the last 10 historical time steps
- **Fcst Trend**: Linear trend coefficient of the forecast values
- Helps assess if the model captures trend continuation or reversal
- Green background distinguishes from accuracy metrics

### Interpretation Guide

#### What Good Forecasts Look Like:
- **Smooth Continuation**: Red forecast line smoothly continues from blue historical data
- **Close Alignment**: Green true values closely follow red forecast predictions
- **Low Metrics**: MSE < 2.0 and MAE < 1.0 typically indicate good performance
- **Trend Consistency**: Historical and forecast trends should be reasonably aligned

#### What to Watch For:
- **Sudden Jumps**: Discontinuities between history and forecast may indicate model issues
- **Poor Alignment**: Large gaps between red forecasts and green true values
- **High Metrics**: MSE > 5.0 or MAE > 2.0 may indicate poor forecast quality
- **Trend Mismatch**: Very different historical vs. forecast trends may suggest overfitting

## üî¨ Detailed Spline Analysis (`spline_analysis.png`)

### Layout: 2√ó3 Grid of Analysis Plots

#### Top Row Analysis

**üìä Control Points by Variable (Top Left)**
- Shows the learned B-spline control points for each ETT variable
- Each colored line represents one variable's control point values
- X-axis: Control point index (0 to num_control_points-1)
- Y-axis: Control point value (in normalized space)
- **Interpretation**: 
  - Similar patterns across variables suggest common forecasting behavior
  - Distinct patterns indicate variable-specific forecast characteristics
  - Smooth progressions suggest stable spline functions

**üìà B-Spline Basis Functions (Top Middle)**
- Mathematical foundation of the spline curves
- Shows the first 6 basis functions used to construct forecasts
- X-axis: Forecast step (1 to forecast_horizon)
- Y-axis: Basis function value
- **Interpretation**:
  - These functions are multiplied by control points to create final forecasts
  - Smooth, overlapping functions ensure continuous predictions
  - Different basis functions contribute to different parts of the forecast horizon

**üìä Control Point Statistics (Top Right)**
- Bar chart showing mean control point values per variable
- Error bars indicate standard deviation across control points
- **Interpretation**:
  - Positive values suggest upward forecast bias
  - Negative values suggest downward forecast bias
  - Large error bars indicate high variability in spline shape

#### Bottom Row Analysis

**üìâ Forecast Uncertainty by Horizon (Bottom Left)**
- Shows how forecast variance changes across the prediction horizon
- X-axis: Forecast step (1 to forecast_horizon)
- Y-axis: Variance across all variables
- **Interpretation**:
  - Generally increasing uncertainty with longer horizons is expected
  - Sudden spikes may indicate model instability at certain horizons
  - Low, stable variance suggests consistent forecast quality

**üîÑ Control Point Correlation Matrix (Bottom Middle)**
- Heatmap showing correlations between variables' control points
- Red indicates positive correlation, blue indicates negative correlation
- **Interpretation**:
  - High correlations suggest variables have similar forecast patterns
  - Low correlations indicate independent forecasting behavior
  - Patterns may reveal underlying system relationships

**üìä Spline Smoothness Analysis (Bottom Right)**
- Bar chart showing smoothness scores for each variable
- Lower values indicate smoother (more continuous) forecasts
- Calculated using second derivatives of forecast curves
- **Interpretation**:
  - Very low values (< 0.1) suggest very smooth forecasts
  - High values (> 1.0) may indicate noisy or unstable predictions
  - Consistent values across variables suggest stable model behavior

## üéØ How to Use These Visualizations

### For Model Development
1. **Check Forecast Quality**: Look at accuracy metrics and visual alignment in main plot
2. **Assess Stability**: Examine smoothness scores and control point patterns
3. **Validate Trends**: Compare historical vs. forecast trends for consistency
4. **Monitor Uncertainty**: Check if forecast uncertainty increases reasonably with horizon

### For Model Interpretation
1. **Understand Predictions**: Control points show how the model constructs forecasts
2. **Identify Patterns**: Correlation matrix reveals variable relationships
3. **Assess Confidence**: Uncertainty analysis helps gauge prediction reliability
4. **Mathematical Insight**: Basis functions provide complete mathematical description

### For Model Debugging
1. **Spot Issues**: Sudden jumps, high metrics, or poor alignment indicate problems
2. **Check Convergence**: Smooth control point patterns suggest proper training
3. **Validate Components**: Each subplot helps isolate different model aspects
4. **Performance Analysis**: Compare metrics across different variables and horizons

## üìã Quick Reference

### Accuracy Metrics Interpretation
- **MSE < 1.0**: Excellent forecast accuracy
- **MSE 1.0-3.0**: Good forecast accuracy  
- **MSE 3.0-5.0**: Moderate forecast accuracy
- **MSE > 5.0**: Poor forecast accuracy (investigate model)

- **MAE < 0.5**: Excellent forecast accuracy
- **MAE 0.5-1.5**: Good forecast accuracy
- **MAE 1.5-2.5**: Moderate forecast accuracy  
- **MAE > 2.5**: Poor forecast accuracy (investigate model)

### Visual Quality Indicators
- ‚úÖ **Good**: Smooth red line, close green alignment, low metrics
- ‚ö†Ô∏è **Moderate**: Some gaps between red/green, moderate metrics
- ‚ùå **Poor**: Large gaps, discontinuities, high metrics

### Control Point Patterns
- **Smooth Progression**: Indicates stable, well-trained splines
- **Erratic Values**: May suggest overfitting or training issues
- **Similar Across Variables**: Suggests common underlying patterns
- **Variable-Specific**: Indicates model captures individual variable characteristics

## üîß Customization Options

The visualization functions support various customization options:

```python
# Custom variable selection
figures = create_spline_visualizations(
    model_output=output,
    input_data=input_data,
    true_future=true_future,
    variable_names=['Custom_Var_1', 'Custom_Var_2', 'Custom_Var_3', 'Custom_Var_4'],
    sample_idx=0,  # Which sample to visualize
    output_dir="custom_output_directory"
)

# Individual plot generation
fig1 = plot_spline_outputs(...)  # Main forecasting plot
fig2 = plot_spline_control_points_analysis(...)  # Detailed analysis
```

## üìö Technical Details

### Data Flow for Visualizations
1. **Model Output**: Extended model generates forecasts and interpretability artifacts
2. **Data Preparation**: Input data and true future values prepared for comparison
3. **Spline Analysis**: Control points and basis functions extracted from model
4. **Visualization Generation**: Matplotlib figures created with comprehensive analysis
5. **File Output**: PNG files saved with high resolution (300 DPI)

### File Locations
- **Test Outputs**: `test_spline_outputs/spline_forecasts.png`, `test_spline_outputs/spline_analysis.png`
- **Validation Outputs**: `spline_validation_outputs/spline_forecasts.png`, `spline_validation_outputs/spline_analysis.png`

### Dependencies
- **matplotlib**: For plot generation
- **numpy**: For numerical computations
- **torch**: For tensor operations
- **pathlib**: For file management

---

**For more information about the model architecture and usage, see the main `README.md` file.**